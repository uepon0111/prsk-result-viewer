<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>プロセカ リザルト管理</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
      :root {
        --bg-color: #f4f7f6;
        --card-bg: #ffffff;
        --text-color: #333;
        --diff-append: #FF82C4;
        --diff-master: #AC3EE6;
        --diff-expert: #DC5268;
        --diff-hard:    #E9B153;
        --fc-color:     #FF82FF;
        --sidebar-width: 200px;
        --active-color: #e8f0fe;
        --active-border: #4285f4;
      }
      body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
      .container { max-width: 1200px; margin: 0 auto; }
      h2 { display: flex; align-items: center; gap: 10px; color: #444; }
      .material-symbols-outlined { font-size: 1.2rem; vertical-align: sub; }
      
      /* Auth & Buttons */
      .auth-section { text-align: right; margin-bottom: 20px; display: flex; justify-content: flex-end; gap: 10px; }
      .btn-auth {
        background-color: #4285f4; color: white; border: none; padding: 10px 20px;
        border-radius: 4px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;
      }
      .btn-auth:hover { background-color: #357ae8; }
      .btn-signout { background-color: #dc3545; }
      .btn-signout:hover { background-color: #c82333; }
      .btn-upload { background-color: #28a745; }
      .btn-upload:hover { background-color: #218838; }
      #auth-status { margin-right: 10px; align-self: center; font-size: 0.9rem; color: #666; }

      /* Controls */
      .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
      .control-group { display: flex; flex-direction: column; }
      .control-group label { font-size: 0.8rem; font-weight: bold; color: #777; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; }
      select, input[type="number"], input[type="text"], input[type="file"] { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; background-color: #fafafa; }
      
      .checkbox-wrapper { display: flex; align-items: center; gap: 8px; height: 42px; background-color: #fafafa; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; }
      input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--diff-master); }
      .checkbox-label { font-size: 0.9rem; cursor: pointer; user-select: none; }

      .status-bar { display: flex; justify-content: flex-end; margin-bottom: 15px; font-size: 0.9rem; color: #666; font-weight: bold; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
      
      /* Card */
      .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; border: 2px solid transparent; position: relative; }
      .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
      .card.is-fc { border-color: var(--fc-color); }
      .card-img-container { width: 100%; height: 140px; background-color: #e0e2e5; overflow: hidden; position: relative; cursor: zoom-in; display: flex; justify-content: center; align-items: center; }
      .card-img { width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.3s ease-in; position: relative; z-index: 2; }
      .img-loader-spinner { position: absolute; width: 24px; height: 24px; border: 3px solid #ddd; border-top: 3px solid #999; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1; }
      
      .fc-badge { position: absolute; top: 8px; right: 8px; background: var(--fc-color); color: white; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 4px; z-index: 3; }
      
      .card-actions { position: absolute; top: 8px; left: 8px; display: flex; gap: 5px; z-index: 10; }
      .action-btn { background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background 0.2s; }
      .action-btn:hover { background: rgba(0,0,0,0.8); }
      .btn-del:hover { background: #dc3545; }
      .btn-edit:hover { background: #007bff; }
      
      .card-body { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
      .song-meta { display: flex; gap: 6px; margin-bottom: 8px; font-size: 0.75rem; }
      .tag { padding: 4px 8px; border-radius: 4px; font-weight: bold; color: white; letter-spacing: 0.5px; }
      .tag.lvl { background-color: #555; }
      .tag.diff-A { background-color: var(--diff-append); }
      .tag.diff-M { background-color: var(--diff-master); }
      .tag.diff-E { background-color: var(--diff-expert); }
      .tag.diff-H { background-color: var(--diff-hard); }
      .song-title { font-weight: bold; font-size: 0.95rem; margin-bottom: 12px; line-height: 1.4; }
      .score-info { font-size: 0.9rem; color: #666; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 8px; margin-top: auto; }
      .miss-val { font-weight: bold; }
      .miss-val.zero { color: var(--fc-color); } 
      
      #loader { display: none; flex-direction: column; align-items: center; margin-top: 50px; color: #666; }
      .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--diff-master); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Modals */
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
      .modal-content-img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); object-fit: contain; }
      
      /* Modal Form Generic */
      .modal-form-content { background-color: #fff; padding: 0; border-radius: 12px; width: 100%; max-width: 1000px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; }
      .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
      .modal-body { display: flex; flex: 1; overflow: hidden; min-height: 400px; }
      
      /* Sidebar Layout (Upload & Edit) */
      .sidebar { width: var(--sidebar-width); background: #fcfcfc; border-right: 1px solid #eee; overflow-y: auto; display: flex; flex-direction: column; }
      .sidebar-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; gap: 10px; align-items: center; transition: background 0.2s; position: relative; }
      .sidebar-item:hover { background-color: #f0f0f0; }
      .sidebar-item.active { background-color: var(--active-color); border-left: 4px solid var(--active-border); }
      .sidebar-thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; background: #ddd; flex-shrink: 0; }
      .sidebar-info { overflow: hidden; font-size: 0.8rem; }
      .sidebar-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
      .sidebar-status { font-size: 0.7rem; color: #666; }
      .sidebar-status.error { color: #dc3545; }
      .sidebar-status.done { color: #28a745; }
      
      /* Main Editor Area */
      .editor-main { flex: 1; padding: 20px; overflow-y: auto; display: flex; gap: 20px; flex-wrap: wrap; }
      .editor-preview { flex: 1; min-width: 300px; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 8px; overflow: hidden; position: relative; height: 400px; }
      .editor-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
      .editor-form { flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 15px; }

      .form-group { margin-bottom: 0; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.8rem; color:#555; }
      .breakdown-row { display: flex; gap: 10px; align-items: center; }
      .breakdown-item { flex: 1; display: flex; flex-direction: column; }
      .breakdown-item input { text-align: center; }
      .breakdown-label { font-size: 0.75rem; color: #666; text-align: center; margin-bottom: 4px; }

      .total-miss-display { text-align: center; font-weight: bold; padding: 10px; background: #eee; border-radius: 8px; margin-top: 10px; }
      .total-miss-val { font-size: 1.2rem; color: #333; }

      .form-actions { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fff; }
      .btn-cancel { background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
      .btn-submit { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
      .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
      .btn-analyze { background-color: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; position: absolute; bottom: 10px; right: 10px; }

      /* Upload Start Screen */
      .drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; color: #777; transition: all 0.2s; cursor: pointer; margin: 20px; background-color: #fcfcfc; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
      .drop-zone:hover, .drop-zone.dragover { border-color: #007bff; background-color: #f0f7ff; color: #007bff; }
      .close-btn { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
    </style>
  </head>
  <body>

    <div id="imageModal" class="modal" onclick="if(event.target === this) closeImageModal()">
      <span class="close-btn" onclick="closeImageModal()">&times;</span>
      <img class="modal-content-img" id="modalImg">
    </div>

    <div id="uploadModal" class="modal" style="background-color: rgba(0,0,0,0.5);">
      <div class="modal-form-content">
        <div class="modal-header">
          <span><span class="material-symbols-outlined">cloud_upload</span> 画像アップロード</span>
          <span style="cursor:pointer;" onclick="closeUploadModal()">&times;</span>
        </div>
        
        <div id="upload-start-view" style="display: flex; flex: 1;">
           <div id="drop-zone" class="drop-zone" onclick="document.getElementById('up-file').click()">
              <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: 10px;">upload_file</span>
              <div>クリックして画像を選択、またはドラッグ＆ドロップ</div>
              <div style="font-size:0.8rem; margin-top:5px; color:#999;">複数枚選択可能</div>
              <input type="file" id="up-file" accept="image/*" multiple style="display: none;">
           </div>
        </div>

        <div id="upload-editor-view" class="modal-body" style="display: none;">
          <div class="sidebar" id="upload-sidebar">
            </div>
          <div class="editor-main">
             <div id="upload-empty-msg" style="margin: auto; color: #999;">左のリストから画像を選択してください</div>
             
             <div id="upload-edit-area" style="display: none; width: 100%; height: 100%; gap:20px; flex-wrap: wrap; display: flex;">
                <div class="editor-preview">
                    <img id="up-preview-img" src="">
                    <div id="up-analyzing-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.6); color:white; justify-content:center; align-items:center; z-index:10;">解析中...</div>
                </div>
                <div class="editor-form">
                    <div class="form-group">
                      <label>曲名</label>
                      <input type="text" id="up-title" style="width: 100%; box-sizing: border-box;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>レベル</label>
                            <input type="number" id="up-level" style="width: 100%; box-sizing: border-box;">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>難易度</label>
                            <select id="up-diff" style="width: 100%; box-sizing: border-box;">
                                <option value="A">Append</option>
                                <option value="M">Master</option>
                                <option value="E">Expert</option>
                                <option value="H">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
                        <label style="text-align:center; margin-bottom:8px;">ミス内訳</label>
                        <div class="breakdown-row">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Good</span>
                                <input type="number" id="up-good" min="0" value="0" oninput="recalcUploadTotal()">
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Bad</span>
                                <input type="number" id="up-bad" min="0" value="0" oninput="recalcUploadTotal()">
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Miss</span>
                                <input type="number" id="up-miss" min="0" value="0" oninput="recalcUploadTotal()">
                            </div>
                        </div>
                        <div class="total-miss-display">
                            合計ミス数: <span id="up-total-display" class="total-miss-val">0</span>
                        </div>
                    </div>

                    <button class="btn-cancel" onclick="removeCurrentUploadItem()" style="background:#dc3545; color:white; margin-top:auto;">この画像を削除</button>
                </div>
             </div>
          </div>
        </div>

        <div class="form-actions" id="upload-actions" style="display: none;">
          <button class="btn-cancel" onclick="closeUploadModal()">キャンセル</button>
          <button class="btn-submit" id="btn-exec-upload" onclick="handleBatchUpload()">全てアップロード</button>
        </div>
      </div>
    </div>

    <div id="editModal" class="modal" style="background-color: rgba(0,0,0,0.5);">
      <div class="modal-form-content" style="max-width: 900px;">
        <div class="modal-header">
          <span><span class="material-symbols-outlined">edit</span> 情報編集</span>
          <span style="cursor:pointer;" onclick="closeEditModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="padding: 20px;">
            <div class="editor-main" style="padding:0;">
                <div class="editor-preview">
                    <img id="edit-preview-img" src="" alt="Preview">
                    <button class="btn-analyze" onclick="runEditAnalysis()">
                        <span class="material-symbols-outlined" style="font-size: 1rem;">analytics</span> 画像を再解析
                    </button>
                </div>

                <div class="editor-form">
                    <input type="hidden" id="edit-id">
                    <input type="hidden" id="edit-original-parent">
                    
                    <div class="form-group">
                      <label>曲名</label>
                      <input type="text" id="edit-title" style="width: 100%; box-sizing: border-box;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>レベル</label>
                            <input type="number" id="edit-level" style="width: 100%; box-sizing: border-box;">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>難易度</label>
                            <select id="edit-diff" style="width: 100%; box-sizing: border-box;">
                                <option value="A">Append</option>
                                <option value="M">Master</option>
                                <option value="E">Expert</option>
                                <option value="H">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-breakdown-area" class="form-group" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
                        <label style="text-align:center; margin-bottom:8px;">解析結果 (内訳)</label>
                        <div class="breakdown-row">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Good</span>
                                <input type="number" id="edit-good" min="0" value="0" oninput="recalcEditTotal()">
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Bad</span>
                                <input type="number" id="edit-bad" min="0" value="0" oninput="recalcEditTotal()">
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Miss</span>
                                <input type="number" id="edit-miss-detail" min="0" value="0" oninput="recalcEditTotal()">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>合計ミス数</label>
                        <input type="number" id="edit-total-miss" min="0" style="width: 100%; box-sizing: border-box; font-weight:bold;">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
          <button class="btn-cancel" onclick="closeEditModal()">キャンセル</button>
          <button class="btn-submit" id="btn-save-edit" onclick="handleEditSave()">保存して反映</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="auth-section">
        <span id="auth-status">未ログイン</span>
        <button id="upload_button" class="btn-auth btn-upload" onclick="openUploadModal()" style="display: none;">
          <span class="material-symbols-outlined">add_photo_alternate</span> アップロード
        </button>
        <button id="authorize_button" class="btn-auth" onclick="handleAuthClick()">
          <span class="material-symbols-outlined">login</span> Googleでログイン
        </button>
        <button id="signout_button" class="btn-auth btn-signout" onclick="handleSignoutClick()" style="display: none;">
          <span class="material-symbols-outlined">logout</span> ログアウト
        </button>
      </div>

      <h2><span class="material-symbols-outlined">library_music</span> リザルト管理 (My Drive)</h2>
      
      <div class="controls">
        <div class="control-group">
          <label><span class="material-symbols-outlined">sort</span> 並べ替え</label>
          <select id="sort-order" onchange="updateView()">
            <option value="title_asc">曲名 (昇順)</option>
            <option value="title_desc">曲名 (降順)</option>
            <option value="level_desc" selected>レベル (高い順)</option>
            <option value="level_asc">レベル (低い順)</option>
            <option value="miss_asc">失点数 (少ない順)</option>
            <option value="miss_desc">失点数 (多い順)</option>
          </select>
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">filter_alt</span> FC状況</label>
          <select id="filter-fc" onchange="updateView()">
            <option value="all">すべて</option>
            <option value="fc">FC済み (FC-0)</option>
            <option value="unfc">未FC (失点あり)</option>
          </select>
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">remove_circle</span> 失点数</label>
          <select id="filter-miss" onchange="updateView()">
            <option value="all">指定なし</option>
            <option value="range-1-5">1 ～ 5</option>
            <option value="range-6-10">6 ～ 10</option>
            <option value="range-11">11以上</option>
          </select>
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">speed</span> 難易度</label>
          <select id="filter-diff" onchange="updateView()">
            <option value="all">すべて</option>
            <option value="A">Append</option>
            <option value="M">Master</option>
            <option value="E">Expert</option>
            <option value="H">Hard</option>
          </select>
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">manage_search</span> 曲名検索</label>
          <input type="text" id="filter-title" placeholder="曲名を入力..." oninput="updateView()">
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">search</span> レベル検索</label>
          <input type="number" id="filter-level" placeholder="" oninput="updateView()">
        </div>
        <div class="control-group">
          <label><span class="material-symbols-outlined">star</span> 表示オプション</label>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="filter-best" onchange="updateView()">
            <label for="filter-best" class="checkbox-label">自己ベストのみ</label>
          </div>
        </div>
      </div>

      <div class="status-bar">
        <span id="result-count">ログインしてください</span>
      </div>

      <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">データを読み込み中...</div>
      </div>
      
      <div id="grid" class="grid"></div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
      // ↓↓↓ GCP Configuration ↓↓↓
      const CLIENT_ID = '966636096862-8hrrm5heb4g5r469veoels7u6ifjguuk.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyC-m1rkHuJTmNK2k-s89bJFshvXCS5MZZ0';
      // ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
      
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/drive';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      let allRecords = [];
      const diffRank = { 'A': 4, 'M': 3, 'E': 2, 'H': 1 };
      
      let dbMusics = [];
      let dbDiffs = [];
      
      window.onload = async function() {
        try {
          const [musicsResp, diffsResp] = await Promise.all([
            fetch('https://sekai-world.github.io/sekai-master-db-diff/musics.json'),
            fetch('https://sekai-world.github.io/sekai-master-db-diff/musicDifficulties.json')
          ]);
          dbMusics = await musicsResp.json();
          dbDiffs = await diffsResp.json();
        } catch (e) {
          console.error("DB Load Error:", e);
        }
      };

      function gapiLoaded() { gapi.load('client', initializeGapiClient); }
      async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
      }
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
        gisInited = true;
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error) throw resp;
          setAuthUI(true);
          await fetchDataFromDrive();
        };
        tokenClient.requestAccessToken({prompt: gapi.client.getToken() === null ? 'consent' : ''});
      }

      function handleSignoutClick() {
        if (gapi.client.getToken()) {
          google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
          gapi.client.setToken('');
          setAuthUI(false);
          document.getElementById('result-count').innerText = 'ログアウトしました';
          document.getElementById('grid').innerHTML = '';
          allRecords = [];
        }
      }

      function setAuthUI(isLoggedIn) {
        document.getElementById('signout_button').style.display = isLoggedIn ? 'inline-flex' : 'none';
        document.getElementById('upload_button').style.display = isLoggedIn ? 'inline-flex' : 'none';
        document.getElementById('authorize_button').style.display = isLoggedIn ? 'none' : 'inline-flex';
        document.getElementById('auth-status').innerText = isLoggedIn ? 'ログイン済み' : '未ログイン';
      }

      // --- Drive Data Logic ---
      async function fetchDataFromDrive() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        document.getElementById('result-count').innerText = 'データ取得中...';
        
        try {
          const root = await getFolderByName("プロセカリザルト");
          if (!root) { allRecords = []; onDataLoaded(); return; }
          
          let current = root;
          const fcFolder = await getFolderByName("FC", root.id);
          if (!fcFolder) { allRecords = []; onDataLoaded(); return; }
          
          document.getElementById('loader-text').innerText = 'フォルダ構造を解析中...';
          const songFolders = await fetchAllDriveItems(`'${fcFolder.id}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`, "id, name");
          
          const folderMap = new Map();
          songFolders.forEach(f => {
            const m = parseFolderTitle(f.name);
            if (m) folderMap.set(f.id, { ...m, folderId: f.id });
          });

          if (songFolders.length === 0) { allRecords = []; onDataLoaded(); return; }

          document.getElementById('loader-text').innerText = '画像を取得中...';
          const files = await fetchAllDriveItems(`name contains 'FC' and mimeType != 'application/vnd.google-apps.folder' and trashed = false`, "id, name, parents, thumbnailLink");

          const records = [];
          files.forEach(file => {
            if (!file.parents) return;
            const pid = file.parents.find(p => folderMap.has(p));
            if (pid) {
              const info = folderMap.get(pid);
              const miss = parseScore(file.name);
              if (miss !== null) {
                records.push({
                  id: file.id, parentId: pid, title: info.title, level: info.level,
                  difficulty: info.difficulty, difficultyRaw: info.rawDiff,
                  missCount: miss, isFC: (miss === 0), thumbnail: file.thumbnailLink || null
                });
              }
            }
          });
          allRecords = records;
          onDataLoaded();
        } catch (e) {
          console.error(e);
          alert("エラーが発生しました: " + e.message);
          loader.style.display = 'none';
        }
      }

      async function fetchAllDriveItems(query, fields) {
        let items = [];
        let pageToken = null;
        do {
          const res = await gapi.client.drive.files.list({ q: query, fields: `nextPageToken, files(${fields})`, pageSize: 1000, pageToken: pageToken });
          if (res.result.files) items = items.concat(res.result.files);
          pageToken = res.result.nextPageToken;
        } while (pageToken);
        return items;
      }
      async function getFolderByName(name, parentId = null) {
        let q = `mimeType = 'application/vnd.google-apps.folder' and name = '${name}' and trashed = false`;
        if (parentId) q += ` and '${parentId}' in parents`;
        const res = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)', pageSize: 1 });
        return (res.result.files && res.result.files.length > 0) ? res.result.files[0] : null;
      }
      async function findOrCreateFolder(name, parentId) {
        const ex = await getFolderByName(name, parentId);
        if (ex) return ex;
        const meta = { 'name': name, 'mimeType': 'application/vnd.google-apps.folder', 'parents': parentId ? [parentId] : [] };
        const res = await gapi.client.drive.files.create({ resource: meta, fields: 'id, name' });
        return res.result;
      }

      // --- OCR Logic ---
      async function cropImage(img, x, y, w, h, type = 'std') {
        const cvs = document.createElement('canvas');
        const ctx = cvs.getContext('2d');
        const nw = img.naturalWidth, nh = img.naturalHeight;
        if (type === 'bin') {
            const s = 1.5; cvs.width = nw*w*s; cvs.height = nh*h*s;
            ctx.drawImage(img, nw*x, nh*y, nw*w, nh*h, 0, 0, cvs.width, cvs.height);
            let d = ctx.getImageData(0,0,cvs.width,cvs.height), dt = d.data;
            for(let i=0; i<dt.length; i+=4) {
                let g = 0.299*dt[i] + 0.587*dt[i+1] + 0.114*dt[i+2];
                dt[i] = dt[i+1] = dt[i+2] = (g > 180) ? 0 : 255;
            }
            ctx.putImageData(d,0,0);
        } else {
            cvs.width = nw*w; cvs.height = nh*h;
            ctx.filter = 'grayscale(100%) contrast(150%)';
            ctx.drawImage(img, nw*x, nh*y, nw*w, nh*h, 0, 0, cvs.width, cvs.height);
        }
        return new Promise(r => cvs.toBlob(r, 'image/png'));
      }

      async function analyzeLoadedImage(img, worker) {
         try {
            // Diff
            const diffB = await cropImage(img, 0.20, 0.07, 0.10, 0.04, 'bin');
            const diffR = await worker.recognize(diffB, { lang: 'eng' }); 
            const dT = diffR.data.text.toUpperCase();
            let dCode = "E", dKey = "expert";
            if (dT.match(/A?P{2}E?N?D?/)) { dCode = "A"; dKey = "append"; }
            else if (dT.includes("MASTER")) { dCode = "M"; dKey = "master"; }
            else if (dT.includes("EXPERT")) { dCode = "E"; dKey = "expert"; }
            else if (dT.includes("HARD")) { dCode = "H"; dKey = "hard"; }

            // Title
            const titleB = await cropImage(img, 0.19, 0.01, 0.32, 0.05);
            const titleR = await worker.recognize(titleB, { lang: 'jpn' });
            let title = titleR.data.text;
            let mId = null;
            
            // Fuzzy Match
            if (dbMusics.length > 0) {
                const norm = s => s.replace(/[Ａ-Ｚａ-ｚ０-９]/g, c => String.fromCharCode(c.charCodeAt(0)-0xFEE0)).toLowerCase().replace(/[\s\-_]/g,'');
                const tNorm = norm(title);
                if (tNorm.length > 0) {
                    let best = null, minS = Infinity;
                    const lev = (a,b) => {
                        if(a.length>b.length)[a,b]=[b,a];
                        let r=Array.from({length:a.length+1},(_,i)=>i);
                        for(let j=0;j<b.length;j++){let n=[j+1];for(let i=0;i<a.length;i++)n.push(a[i]===b[j]?r[i]:1+Math.min(r[i],r[i+1],n[n.length-1]));r=n;}
                        return r[r.length-1];
                    };
                    for(const m of dbMusics){
                        const dist = lev(tNorm, norm(m.title));
                        const score = dist/Math.max(tNorm.length, norm(m.title).length);
                        if(score < minS){ minS=score; best=m; }
                    }
                    if(best) { title = best.title; mId = best.id; }
                }
            }
            title = title.replace(/\r?\n/g, '').trim();

            // Level
            let level = "";
            if (mId) {
                const dE = dbDiffs.find(d => d.musicId === mId && d.musicDifficulty === dKey);
                if(dE) level = dE.playLevel;
            }

            // Miss (Detail)
            const missB = await cropImage(img, 0.10, 0.55, 0.20, 0.28);
            const missR = await worker.recognize(missB, { lang: 'jpn' });
            const lines = missR.data.text.split('\n');
            let cG=0, cB=0, cM=0;
            const parse = (l,r) => { if(r.test(l)){ const n=l.match(/\d+/g); if(n) return parseInt(n[n.length-1],10); } return 0; };
            lines.forEach(l => {
              if (/G[O0QD]{2}D/i.test(l)) cG = parse(l, /G[O0QD]{2}D/i);
              if (/BAD/i.test(l))  cB  = parse(l, /BAD/i);
              if (/MISS/i.test(l)) cM = parse(l, /MISS/i);
            });
            const total = cG + cB + cM;

            return { title, level, diff: dCode, miss: total, details: {good: cG, bad: cB, miss: cM}, musicId: mId };
        } catch (e) { console.error(e); return null; }
      }
      
      async function analyzeImageFile(file, worker) {
        return new Promise(r => {
            const img = new Image();
            img.onload = async () => r(await analyzeLoadedImage(img, worker));
            img.src = URL.createObjectURL(file);
        });
      }

      // --- Upload State Management ---
      let uploadQueue = []; // { id, file, result: {title, level, diff, miss, details...} }
      let currentUploadIndex = -1;

      const dropZone = document.getElementById('drop-zone');
      dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
      dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); });
      document.getElementById('up-file').addEventListener('change', e => handleFiles(e.target.files));

      function openUploadModal() {
        document.getElementById('uploadModal').style.display = 'flex';
        // Reset View
        uploadQueue = [];
        currentUploadIndex = -1;
        document.getElementById('upload-start-view').style.display = 'flex';
        document.getElementById('upload-editor-view').style.display = 'none';
        document.getElementById('upload-actions').style.display = 'none';
        document.getElementById('up-file').value = "";
      }
      function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }

      async function handleFiles(files) {
        if (files.length === 0) return;
        
        // Switch View
        document.getElementById('upload-start-view').style.display = 'none';
        document.getElementById('upload-editor-view').style.display = 'flex'; // sidebar + main
        document.getElementById('upload-actions').style.display = 'flex';

        const worker = await Tesseract.createWorker(['jpn', 'eng']);
        
        // Initialize Queue Items
        const startIndex = uploadQueue.length;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const id = Date.now() + "_" + i;
            uploadQueue.push({
                id: id,
                file: file,
                status: 'pending',
                data: { title:'', level:'', diff:'E', miss:0, details:{good:0, bad:0, miss:0}, musicId:null }
            });
        }
        
        renderSidebar();
        if (startIndex === 0 && uploadQueue.length > 0) selectUploadItem(0);

        // Run Analysis sequentially or parallel (doing seq for safety)
        for (let i = startIndex; i < uploadQueue.length; i++) {
            const item = uploadQueue[i];
            updateSidebarStatus(i, '解析中...');
            
            const res = await analyzeImageFile(item.file, worker);
            if (res) {
                item.data = res;
                item.status = 'done';
                updateSidebarStatus(i, 'OK', 'done');
            } else {
                item.status = 'error';
                updateSidebarStatus(i, '失敗', 'error');
            }
            
            // If this item is currently selected, update form
            if (currentUploadIndex === i) populateUploadForm(i);
        }
        await worker.terminate();
        updateUploadBtn();
      }

      function renderSidebar() {
        const sb = document.getElementById('upload-sidebar');
        sb.innerHTML = '';
        uploadQueue.forEach((item, idx) => {
           const div = document.createElement('div');
           div.className = `sidebar-item ${idx === currentUploadIndex ? 'active' : ''}`;
           div.onclick = () => selectUploadItem(idx);
           div.innerHTML = `
              <img src="${URL.createObjectURL(item.file)}" class="sidebar-thumb">
              <div class="sidebar-info">
                 <div class="sidebar-title" id="sb-title-${idx}">${item.data.title || '（未解析）'}</div>
                 <div class="sidebar-status" id="sb-status-${idx}">${item.status === 'pending' ? '待機中' : (item.status==='done'?'OK':'エラー')}</div>
              </div>
           `;
           sb.appendChild(div);
        });
      }

      function updateSidebarStatus(idx, text, type) {
          const el = document.getElementById(`sb-status-${idx}`);
          if(el) {
              el.innerText = text;
              el.className = `sidebar-status ${type || ''}`;
          }
          const tEl = document.getElementById(`sb-title-${idx}`);
          if(tEl && uploadQueue[idx].data.title) tEl.innerText = uploadQueue[idx].data.title;
      }

      function selectUploadItem(idx) {
        // Save current if needed? No, input events update data directly.
        currentUploadIndex = idx;
        renderSidebar(); // update active class
        populateUploadForm(idx);
      }

      function populateUploadForm(idx) {
        const item = uploadQueue[idx];
        if (!item) return;
        
        document.getElementById('upload-empty-msg').style.display = 'none';
        document.getElementById('upload-edit-area').style.display = 'flex';
        
        document.getElementById('up-preview-img').src = URL.createObjectURL(item.file);
        
        // Populate inputs
        const d = item.data;
        document.getElementById('up-title').value = d.title;
        document.getElementById('up-level').value = d.level;
        document.getElementById('up-diff').value = d.diff;
        
        // Breakdown
        document.getElementById('up-good').value = d.details.good;
        document.getElementById('up-bad').value = d.details.bad;
        document.getElementById('up-miss').value = d.details.miss;
        document.getElementById('up-total-display').innerText = d.miss;

        // Attach Live Listeners
        ['up-title', 'up-level', 'up-diff'].forEach(id => {
            document.getElementById(id).oninput = function() {
                if(id==='up-title') {
                    item.data.title = this.value; 
                    document.getElementById(`sb-title-${idx}`).innerText = this.value || '(名称未設定)';
                }
                if(id==='up-level') item.data.level = this.value;
                if(id==='up-diff') {
                     item.data.diff = this.value;
                     if (item.data.musicId) {
                         const map = {'A':'append', 'M':'master', 'E':'expert', 'H':'hard'};
                         const nl = getLevelFromDb(item.data.musicId, map[this.value]);
                         if(nl) {
                             document.getElementById('up-level').value = nl;
                             item.data.level = nl;
                         }
                     }
                }
            }
        });
      }
      
      function recalcUploadTotal() {
          if (currentUploadIndex < 0) return;
          const g = parseInt(document.getElementById('up-good').value) || 0;
          const b = parseInt(document.getElementById('up-bad').value) || 0;
          const m = parseInt(document.getElementById('up-miss').value) || 0;
          const total = g + b + m;
          
          document.getElementById('up-total-display').innerText = total;
          
          // Update Data Store
          uploadQueue[currentUploadIndex].data.details = { good: g, bad: b, miss: m };
          uploadQueue[currentUploadIndex].data.miss = total;
      }

      function removeCurrentUploadItem() {
          if (currentUploadIndex < 0) return;
          uploadQueue.splice(currentUploadIndex, 1);
          currentUploadIndex = -1;
          renderSidebar();
          if (uploadQueue.length > 0) selectUploadItem(0);
          else {
              document.getElementById('upload-edit-area').style.display = 'none';
              document.getElementById('upload-empty-msg').style.display = 'block';
              document.getElementById('upload-actions').style.display = 'none';
              document.getElementById('upload-start-view').style.display = 'flex'; // Back to drop zone
          }
          updateUploadBtn();
      }

      function updateUploadBtn() {
          const btn = document.getElementById('btn-exec-upload');
          btn.innerText = uploadQueue.length ? `全てアップロード (${uploadQueue.length}件)` : '全てアップロード';
          btn.disabled = uploadQueue.length === 0;
      }

      function getLevelFromDb(mid, diffKey) {
          const e = dbDiffs.find(d => d.musicId === mid && d.musicDifficulty === diffKey);
          return e ? e.playLevel : null;
      }

      async function handleBatchUpload() {
          if(!uploadQueue.length) return;
          const btn = document.getElementById('btn-exec-upload');
          btn.disabled = true; btn.innerText = "アップロード中...";
          
          const root = await findOrCreateFolder("プロセカリザルト");
          const fcF = await findOrCreateFolder("FC", root.id);
          
          let success = 0;
          const token = gapi.client.getToken().access_token;
          
          // Process loop
          const toProcess = [...uploadQueue];
          for (const item of toProcess) {
              const d = item.data;
              if (!d.title || !d.level) continue; // Skip incomplete

              try {
                  const folderName = `${d.level}${d.diff} ${d.title}`;
                  const sFolder = await findOrCreateFolder(folderName, fcF.id);
                  const fileName = (d.miss === 0) ? "FC" : `FC-${d.miss}`;
                  
                  const meta = { 'name': fileName, 'parents': [sFolder.id] };
                  const form = new FormData();
                  form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                  form.append('file', item.file);

                  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                      method: 'POST',
                      headers: new Headers({ 'Authorization': 'Bearer ' + token }),
                      body: form
                  });
                  if(!res.ok) throw new Error("Upload failed");
                  
                  // Success: remove from queue
                  const idx = uploadQueue.findIndex(q => q.id === item.id);
                  if(idx > -1) uploadQueue.splice(idx, 1);
                  success++;
              } catch(e) {
                  console.error(e);
              }
          }
          
          if (uploadQueue.length === 0) {
              alert(`アップロード完了 (${success}件)`);
              closeUploadModal();
              await fetchDataFromDrive();
          } else {
              alert(`${success}件完了。エラー項目が残っています。`);
              renderSidebar();
              selectUploadItem(0);
              updateUploadBtn();
          }
      }

      // --- Edit Logic ---
      function openEditModal(id) {
        const r = allRecords.find(x => x.id === id);
        if(!r) return;
        document.getElementById('editModal').style.display = 'flex';
        document.getElementById('edit-id').value = r.id;
        document.getElementById('edit-original-parent').value = r.parentId;
        document.getElementById('edit-title').value = r.title;
        document.getElementById('edit-level').value = r.level;
        document.getElementById('edit-diff').value = r.difficultyRaw;
        document.getElementById('edit-total-miss').value = r.missCount;
        
        // Initial state: hide breakdown because we don't know it without OCR
        document.getElementById('edit-breakdown-area').style.display = 'none';
        
        const img = document.getElementById('edit-preview-img');
        img.src = r.thumbnail ? r.thumbnail.replace('=s220','=w1600') : '';
        img.crossOrigin = "anonymous";
      }
      function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

      async function runEditAnalysis() {
          const img = document.getElementById('edit-preview-img');
          if(!img.src) return;
          const btn = document.querySelector('#editModal .btn-analyze');
          btn.disabled = true; btn.innerHTML = '解析中...';
          
          try {
              const worker = await Tesseract.createWorker(['jpn','eng']);
              const res = await analyzeLoadedImage(img, worker);
              await worker.terminate();
              
              if(res) {
                  document.getElementById('edit-title').value = res.title;
                  document.getElementById('edit-level').value = res.level;
                  document.getElementById('edit-diff').value = res.diff;
                  
                  // Show breakdown
                  document.getElementById('edit-breakdown-area').style.display = 'block';
                  document.getElementById('edit-good').value = res.details.good;
                  document.getElementById('edit-bad').value = res.details.bad;
                  document.getElementById('edit-miss-detail').value = res.details.miss;
                  document.getElementById('edit-total-miss').value = res.miss;
              } else {
                  alert("解析失敗");
              }
          } catch(e) {
              console.error(e); alert("エラー: "+e.message);
          } finally {
              btn.disabled = false; btn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 1rem;">analytics</span> 画像を再解析';
          }
      }

      function recalcEditTotal() {
          const g = parseInt(document.getElementById('edit-good').value) || 0;
          const b = parseInt(document.getElementById('edit-bad').value) || 0;
          const m = parseInt(document.getElementById('edit-miss-detail').value) || 0;
          document.getElementById('edit-total-miss').value = g + b + m;
      }

      async function handleEditSave() {
        const id = document.getElementById('edit-id').value;
        const oldP = document.getElementById('edit-original-parent').value;
        const tit = document.getElementById('edit-title').value.trim();
        const lvl = document.getElementById('edit-level').value.trim();
        const dif = document.getElementById('edit-diff').value;
        const mis = document.getElementById('edit-total-miss').value;

        if(!tit || !lvl || !mis) { alert("入力不備があります"); return; }
        
        const btn = document.getElementById('btn-save-edit');
        btn.disabled = true; btn.innerText = "保存中...";
        
        try {
            const root = await findOrCreateFolder("プロセカリザルト");
            const fcF = await findOrCreateFolder("FC", root.id);
            const targetF = await findOrCreateFolder(`${lvl}${dif} ${tit}`, fcF.id);
            
            const newName = (parseInt(mis)===0) ? "FC" : `FC-${mis}`;
            
            const body = { name: newName };
            const params = { fileId: id, resource: body };
            if(targetF.id !== oldP) { params.addParents = targetF.id; params.removeParents = oldP; }
            
            await gapi.client.drive.files.update(params);
            
            closeEditModal();
            await fetchDataFromDrive();
        } catch(e) {
            console.error(e); alert("保存失敗: "+e.message);
        } finally {
            btn.disabled = false; btn.innerText = "保存して反映";
        }
      }

      async function deleteFile(id) { await gapi.client.drive.files.delete({ fileId: id }); }
      async function confirmDelete(id, title) {
          if(confirm(`「${title}」を削除しますか？`)) {
              document.getElementById('loader').style.display='flex';
              try { await deleteFile(id); await fetchDataFromDrive(); } 
              catch(e) { alert("削除失敗"); console.error(e); }
          }
      }

      // --- View Helpers ---
      function parseFolderTitle(n) {
          const m = n.match(/^(\d+)([AMEH])\s+(.+)$/);
          if(!m) return null;
          const map = {'A':'Append','M':'Master','E':'Expert','H':'Hard'};
          return { level: parseInt(m[1],10), rawDiff: m[2], difficulty: map[m[2]], title: m[3] };
      }
      function parseScore(n) {
          const m = n.match(/^FC(?:-(\d+))?/);
          return m ? (m[1]===undefined?0:parseInt(m[1],10)) : null;
      }
      function updateView() {
          if(!allRecords.length) return;
          const fc=document.getElementById('filter-fc').value, ms=document.getElementById('filter-miss').value,
                df=document.getElementById('filter-diff').value, lv=document.getElementById('filter-level').value,
                best=document.getElementById('filter-best').checked,
                tt=document.getElementById('filter-title').value.toLowerCase().trim();
          
          let list = allRecords;
          if(best) {
              const bMap = new Map();
              list.forEach(r => {
                  const k = r.title + r.difficultyRaw;
                  if(!bMap.has(k) || r.missCount < bMap.get(k).missCount) bMap.set(k, r);
              });
              list = Array.from(bMap.values());
          }
          
          list = list.filter(r => {
              if(fc==='fc' && !r.isFC) return false;
              if(fc==='unfc' && r.isFC) return false;
              if(ms!=='all') {
                  if(r.isFC) return false;
                  if(ms==='range-1-5' && (r.missCount<1||r.missCount>5)) return false;
                  if(ms==='range-6-10' && (r.missCount<6||r.missCount>10)) return false;
                  if(ms==='range-11' && r.missCount<11) return false;
              }
              if(df!=='all' && r.difficultyRaw!==df) return false;
              if(lv && r.level!=lv) return false;
              if(tt && !r.title.toLowerCase().includes(tt)) return false;
              return true;
          });

          const so = document.getElementById('sort-order').value;
          list.sort((a,b) => {
              if(so==='title_asc') return a.title.localeCompare(b.title,'ja') || a.missCount-b.missCount;
              if(so==='title_desc') return b.title.localeCompare(a.title,'ja') || a.missCount-b.missCount;
              if(so==='level_desc') return b.level-a.level || a.missCount-b.missCount;
              if(so==='level_asc') return a.level-b.level || a.missCount-b.missCount;
              if(so==='miss_asc') return a.missCount-b.missCount || b.level-a.level;
              if(so==='miss_desc') return b.missCount-a.missCount || b.level-a.level;
              return 0;
          });
          
          const grid = document.getElementById('grid');
          document.getElementById('result-count').innerText = `表示: ${list.length} 件`;
          grid.innerHTML = '';
          if(list.length===0) { grid.innerHTML='<div style="grid-column:1/-1;text-align:center;">該当なし</div>'; return; }
          
          list.forEach(r => {
              const th = r.thumbnail ? r.thumbnail.replace('=s220','=w600') : '';
              const lg = r.thumbnail ? r.thumbnail.replace('=s220','=w1600') : '';
              const miss = r.isFC ? '<span class="miss-val zero">FC-0</span>' : `FC -<span class="miss-val">${r.missCount}</span>`;
              const bdg = r.isFC ? `<div class="fc-badge"><span class="material-symbols-outlined" style="font-size:1rem;">crown</span> FULL COMBO</div>` : '';
              
              grid.innerHTML += `
               <div class="card ${r.isFC?'is-fc':''}">
                 <div class="card-img-container" onclick="openImageModal('${lg}')">
                   <div class="card-actions">
                       <button class="action-btn btn-del" onclick="confirmDelete('${r.id}','${r.title.replace(/'/g,"\\'")}')"><span class="material-symbols-outlined">delete</span></button>
                       <button class="action-btn btn-edit" onclick="event.stopPropagation();openEditModal('${r.id}')"><span class="material-symbols-outlined">edit</span></button>
                   </div>
                   ${bdg}
                   <div class="img-loader-spinner"></div>
                   ${th?`<img src="${th}" class="card-img" loading="lazy" onload="this.style.opacity=1;this.previousElementSibling.style.display='none';">`:'<span style="color:#aaa">NO IMG</span>'}
                 </div>
                 <div class="card-body">
                   <div class="song-meta"><span class="tag lvl">Lv.${r.level}</span><span class="tag diff-${r.difficultyRaw}">${r.difficulty}</span></div>
                   <div class="song-title">${r.title}</div>
                   <div class="score-info"><span style="display:flex;align-items:center;"><span class="material-symbols-outlined" style="font-size:1rem;">bar_chart</span> Result</span>${miss}</div>
                 </div>
               </div>
              `;
          });
      }
      function openImageModal(s){ if(!s)return; document.getElementById('imageModal').style.display="flex"; document.getElementById('modalImg').src=s; }
      function closeImageModal(){ document.getElementById('imageModal').style.display="none"; }
    </script>
  </body>
</html>
