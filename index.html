<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>プロセカ リザルト管理</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
      :root {
        --bg-color: #f4f7f6;
        --card-bg: #ffffff;
        --text-color: #333;
        --diff-append: #FF82C4;
        --diff-master: #AC3EE6;
        --diff-expert: #DC5268;
        --diff-hard:    #E9B153;
        --diff-normal:  #5DBCFF;
        --diff-easy:    #6EE172;
        --fc-color:     #FF82FF;
      }
      body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
      h1 { text-align: center; color: #444; margin-bottom: 20px; }
      
      .container { max-width: 800px; margin: 0 auto; }
      
      /* Input Area */
      .input-area { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; flex-direction: column; gap: 15px; }
      .file-drop-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
      .file-drop-zone:hover { border-color: #888; background: #f0f0f0; }
      .preview-img { max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px; display: none; }
      
      .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
      .form-group { flex: 1; display: flex; flex-direction: column; min-width: 120px; }
      label { font-size: 0.85rem; font-weight: bold; margin-bottom: 4px; color: #666; }
      input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1rem; }
      
      .btn-add { background: linear-gradient(135deg, #33d9b2, #218c74); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; margin-top: 10px; }
      .btn-add:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(51, 217, 178, 0.4); }
      .btn-add:disabled { background: #ccc; transform: none; box-shadow: none; cursor: not-allowed; }

      /* Loading Overlay */
      .loading-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8); z-index: 999;
        flex-direction: column; align-items: center; justify-content: center;
      }
      .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #33d9b2; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .loading-text { margin-top: 15px; font-weight: bold; color: #555; }

      /* Grid */
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
      
      /* Card */
      .card { background: var(--card-bg); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; position: relative; }
      .card:hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
      
      .card-img-area { width: 100%; height: 160px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; }
      .card-img-area img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
      
      .card-body { padding: 15px; }
      .song-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
      
      .tag.diff-APPEND { background: var(--diff-append); }
      .tag.diff-MASTER { background: var(--diff-master); }
      .tag.diff-EXPERT { background: var(--diff-expert); }
      .tag.diff-HARD   { background: var(--diff-hard); }
      .tag.diff-NORMAL { background: var(--diff-normal); }
      .tag.diff-EASY   { background: var(--diff-easy); }
      .tag.lvl { background: #555; }

      .song-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      
      .score-info { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; color: #666; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; }
      .miss-count { color: #aaa; font-weight: bold; }
      .miss-count.fc { color: var(--fc-color); }
      
      /* Modal */
      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
      .modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
      
      /* Canvas for processing (Hidden) */
      #procCanvas { display: none; }
    </style>
  </head>
  <body>

    <div class="loading-overlay" id="loader">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>

    <div class="container">
      <h1>プロセカ リザルト管理</h1>
      
      <div class="input-area">
        <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          <span class="material-symbols-outlined" style="font-size: 48px; color: #ccc;">add_photo_alternate</span>
          <p style="margin: 10px 0 0; color: #888;">タップまたはドラッグ＆ドロップで画像をアップロード<br>(自動解析)</p>
          <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
          <img id="preview" class="preview-img">
        </div>

        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label>楽曲タイトル</label>
            <input type="text" id="inputTitle" placeholder="例: ネクラチューンサーカス">
          </div>
          <div class="form-group">
            <label>難易度</label>
            <select id="inputDiff">
              <option value="APPEND">APPEND</option>
              <option value="MASTER">MASTER</option>
              <option value="EXPERT">EXPERT</option>
              <option value="HARD">HARD</option>
              <option value="NORMAL">NORMAL</option>
              <option value="EASY">EASY</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>レベル</label>
            <input type="number" id="inputLevel" placeholder="34">
          </div>
          <div class="form-group">
            <label>Miss数 (Good+Bad+Miss)</label>
            <input type="number" id="inputMiss" placeholder="0">
          </div>
        </div>
        
        <button class="btn-add" id="btnAdd" onclick="addRecord()">記録を追加</button>
      </div>

      <div class="grid" id="recordGrid">
        </div>
    </div>

    <div class="modal" id="imageModal" onclick="closeImageModal()">
      <img id="modalImg" src="">
    </div>

    <canvas id="procCanvas"></canvas>

    <script>
      // 楽曲データ
      const MUSICS_JSON_URL = "https://raw.githubusercontent.com/Sekai-World/sekai-master-db-diff/main/musics.json";
      let musicDatabase = [];
      let currentImageBase64 = null;

      // ページ読み込み時に楽曲データを取得
      window.onload = async () => {
        try {
          const response = await fetch(MUSICS_JSON_URL);
          musicDatabase = await response.json();
          console.log("Music DB loaded:", musicDatabase.length, "songs");
        } catch (e) {
          console.error("Failed to load music DB", e);
        }
      };

      // --- ファイル処理 ---
      
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        processImage(file);
      }

      // ドラッグ&ドロップ対応
      const dropZone = document.getElementById('dropZone');
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#33d9b2'; });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#ccc'; });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          processImage(file);
        }
      });

      // --- 画像処理 & OCR (メインロジック) ---

      async function processImage(file) {
        // プレビュー表示
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('preview').src = e.target.result;
          document.getElementById('preview').style.display = 'block';
          currentImageBase64 = e.target.result;
        };
        reader.readAsDataURL(file);

        // OCR開始
        showLoading(true, "解析中... 画像を処理しています");
        
        try {
          // 1. 画像の前処理（Canvasへの描画と切り出し）
          const imgBitmap = await createImageBitmap(file);
          const canvas = document.getElementById('procCanvas');
          const ctx = canvas.getContext('2d');
          
          const w = imgBitmap.width;
          const h = imgBitmap.height;

          // レイアウト調整用定数（プロセカのリザルト画面の一般的な配置に基づく％指定）
          // タイトル・難易度エリア（左上）
          const headerRegion = { x: 0, y: 0, w: w * 0.5, h: h * 0.4 };
          // 判定エリア（右側、Good/Bad/Missがあるあたり）
          const judgeRegion = { x: w * 0.5, y: h * 0.3, w: w * 0.5, h: h * 0.6 };

          // --- ① ヘッダー解析（タイトル・難易度） ---
          showLoading(true, "文字を読み取っています (1/2)");
          const headerDataUrl = getProcessedDataUrl(imgBitmap, headerRegion);
          
          // 日本語+英語で解析
          const headerResult = await Tesseract.recognize(
            headerDataUrl,
            'jpn+eng',
            { logger: m => console.log(m) }
          );
          const headerText = headerResult.data.text;
          console.log("Header OCR:", headerText);

          // --- ② 判定詳細解析（数字） ---
          showLoading(true, "スコアを読み取っています (2/2)");
          const judgeDataUrl = getProcessedDataUrl(imgBitmap, judgeRegion, true); // true = 数字強化処理

          // 英語のみ（数字重視）
          const judgeResult = await Tesseract.recognize(
            judgeDataUrl,
            'eng',
            { 
              logger: m => console.log(m),
              tessedit_char_whitelist: 'PERFECTGREATGOODBADMISS0123456789' // 数字と判定文字のみ許可
            }
          );
          const judgeText = judgeResult.data.text;
          console.log("Judge OCR:", judgeText);

          // --- データ抽出と推論 ---

          // 1. タイトル推論 (DBとのファジーマッチ)
          // OCR結果から改行で区切って、最もDBに近い行を探す
          const lines = headerText.split(/\r?\n/).filter(l => l.trim().length > 1);
          let bestTitle = "";
          let bestScore = Infinity;

          // DB検索
          lines.forEach(line => {
            // ノイズ除去
            const cleanLine = line.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '');
            if(cleanLine.length < 2) return;

            musicDatabase.forEach(music => {
              const dist = levenshtein(cleanLine, music.title);
              // タイトル長に対する距離の割合で評価（長いタイトルほど許容）
              const score = dist / Math.max(cleanLine.length, music.title.length);
              
              if (score < bestScore) {
                bestScore = score;
                bestTitle = music.title;
              }
            });
          });
          
          // ヒットしなければOCRの生テキスト（の最も長い行）を暫定使用
          if (bestScore > 0.4) { // しきい値
             // DBマッチがいまいちな場合、OCR結果の中で"楽曲名っぽい場所"を探す
             // 通常、難易度の下にある最も大きな文字だが、ここでは簡易的に一番長い行を採用
             bestTitle = lines.sort((a,b) => b.length - a.length)[0] || "";
          }

          // 2. 難易度推論
          let detectedDiff = "MASTER"; // デフォルト
          const diffMap = ["APPEND", "MASTER", "EXPERT", "HARD", "NORMAL", "EASY"];
          // ヘッダーテキスト全体から検索
          let minDiffDist = Infinity;
          diffMap.forEach(diff => {
            // OCRテキスト内にその単語が含まれているか、あるいは非常に近いか
            if (headerText.toUpperCase().includes(diff)) {
              detectedDiff = diff;
              minDiffDist = 0;
            } else {
               // 単語が見つからない場合、一番近い文字列を探す簡易ロジック
               // ここでは単純化のためincludeチェックを優先
            }
          });

          // 3. レベル推論 (数字の検索)
          // 難易度文字の近くにある2桁の数字を探す (例: MASTER 34)
          const levelMatch = headerText.match(/(?:APPEND|MASTER|EXPERT|HARD|NORMAL|EASY).*?(\d{2})/i) 
                          || headerText.match(/Lv\.?\s*(\d{2})/i)
                          || headerText.match(/(\d{2})/); // 最悪ただの2桁数字
          const detectedLevel = levelMatch ? levelMatch[1] : "";

          // 4. ミス数計算 (GOOD + BAD + MISS)
          // judgeTextから "GOOD" "BAD" "MISS" の後ろにある数字を拾う
          // Tesseractは行がずれることがあるため、単語と数字のペアを探す
          const countGood = extractJudgeCount(judgeText, "GOOD");
          const countBad  = extractJudgeCount(judgeText, "BAD");
          const countMiss = extractJudgeCount(judgeText, "MISS");
          
          const totalMiss = countGood + countBad + countMiss;
          console.log(`Miss Calc: G:${countGood} + B:${countBad} + M:${countMiss} = ${totalMiss}`);

          // --- UIへの反映 ---
          document.getElementById('inputTitle').value = bestTitle;
          document.getElementById('inputDiff').value = detectedDiff;
          document.getElementById('inputLevel').value = detectedLevel;
          document.getElementById('inputMiss').value = totalMiss;

        } catch (err) {
          console.error(err);
          alert("画像の解析に失敗しました。");
        } finally {
          showLoading(false);
        }
      }

      // --- 画像前処理用ヘルパー ---
      
      // 画像をCanvasに切り出して二値化処理を行ったDataURLを返す
      function getProcessedDataUrl(imgBitmap, region, enhanceNumbers = false) {
        const canvas = document.getElementById('procCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = region.w;
        canvas.height = region.h;
        
        // 切り出し描画
        ctx.drawImage(imgBitmap, region.x, region.y, region.w, region.h, 0, 0, region.w, region.h);
        
        // ピクセル操作（二値化）
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imgData.data;
        
        // 閾値処理
        const threshold = 160; // 白背景の黒文字、あるいは明るい文字を抽出するための閾値
        
        for (let i = 0; i < data.length; i += 4) {
          // グレースケール変換 (RGB平均)
          const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
          
          // ハイコントラスト化（白か黒にする）
          // リザルト画面は背景が派手なことが多いので、文字をくっきりさせる
          const val = avg > threshold ? 255 : 0;
          
          // enhanceNumbersの場合、さらにノイズ除去などを入れても良いが今回はシンプルに
          
          data[i] = val;     // R
          data[i+1] = val;   // G
          data[i+2] = val;   // B
          // Alphaはそのまま
        }
        
        ctx.putImageData(imgData, 0, 0);
        return canvas.toDataURL('image/png');
      }

      // 判定の数字を抽出する正規表現ロジック
      function extractJudgeCount(text, label) {
        // パターン1: "GOOD 6" のように同じ行にある
        const regexInline = new RegExp(`${label}\\s*[:.]?\\s*(\\d+)`, 'i');
        let match = text.match(regexInline);
        if (match) return parseInt(match[1]);

        // パターン2: 改行されている場合 (Tesseractでよくある)
        // "GOOD" の次に出現する数字を探す
        // 単語位置を探す
        const words = text.split(/\s+/);
        const labelIndex = words.findIndex(w => w.toUpperCase().includes(label));
        if (labelIndex !== -1 && labelIndex + 1 < words.length) {
          const nextWord = words[labelIndex + 1];
          if (/^\d+$/.test(nextWord)) {
            return parseInt(nextWord);
          }
        }
        return 0; // 見つからなければ0
      }

      // レーベンシュタイン距離 (文字列類似度計算)
      function levenshtein(s1, s2) {
        if (!s1) return s2 ? s2.length : 0;
        if (!s2) return s1.length;
        const a = s1.length, b = s2.length;
        const matrix = [];

        for (let i = 0; i <= b; i++) matrix[i] = [i];
        for (let j = 0; j <= a; j++) matrix[0][j] = j;

        for (let i = 1; i <= b; i++) {
          for (let j = 1; j <= a; j++) {
            if (s2.charAt(i - 1) == s1.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
              );
            }
          }
        }
        return matrix[b][a];
      }

      // --- UI操作 ---

      function addRecord() {
        const title = document.getElementById('inputTitle').value;
        const diff = document.getElementById('inputDiff').value;
        const level = document.getElementById('inputLevel').value;
        const miss = document.getElementById('inputMiss').value;
        
        if (!title) { alert("タイトルを入力してください"); return; }
        
        const record = {
          id: Date.now(),
          title: title,
          difficulty: diff, // UI表示用
          difficultyRaw: diff, // CSSクラス用
          level: level,
          miss: miss,
          image: currentImageBase64
        };
        
        renderCard(record);
        
        // フォームリセット
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputLevel').value = '';
        document.getElementById('inputMiss').value = '';
        document.getElementById('preview').style.display = 'none';
        currentImageBase64 = null;
        document.getElementById('fileInput').value = '';
      }

      function renderCard(rec) {
        const grid = document.getElementById('recordGrid');
        
        let missDisplay = '';
        if (parseInt(rec.miss) === 0) {
          missDisplay = `<span class="miss-count fc"><span class="material-symbols-outlined" style="vertical-align:middle; font-size:1.1rem;">verified</span> FULL COMBO</span>`;
        } else {
          missDisplay = `<span class="miss-count">MISS ${rec.miss}</span>`;
        }

        const html = `
          <div class="card">
            <div class="card-img-area" onclick="openImageModal('${rec.image}')">
              ${rec.image 
                ? `<img src="${rec.image}">` 
                : '<span style="color:#aaa;">NO IMAGE</span>'}
            </div>
            <div class="card-body">
              <div class="song-meta">
                <span class="tag lvl">Lv.${rec.level}</span>
                <span class="tag diff-${rec.difficultyRaw}">${rec.difficulty}</span>
              </div>
              <div class="song-title">${escapeHtml(rec.title)}</div>
              <div class="score-info">
                <span style="display:flex; align-items:center; gap:2px;">
                  <span class="material-symbols-outlined" style="font-size:1rem;">bar_chart</span> Result
                </span>
                ${missDisplay}
              </div>
            </div>
          </div>
        `;
        // 先頭に追加
        grid.insertAdjacentHTML('afterbegin', html);
      }

      function openImageModal(src) {
        if(!src || src === 'null') return;
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        modal.style.display = "flex";
        modalImg.src = src;
      }

      function closeImageModal() {
        document.getElementById('imageModal').style.display = "none";
      }

      function showLoading(show, text) {
        const overlay = document.getElementById('loader');
        const txt = document.getElementById('loadingText');
        overlay.style.display = show ? 'flex' : 'none';
        if(text) txt.innerText = text;
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text.toString().replace(/[&<>"']/g, function(m) {
          return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
        });
      }
    </script>
  </body>
</html>
