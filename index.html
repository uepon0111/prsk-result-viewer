// --- UI Logic (Optimized) ---

      function updateView() {
        if (!allRecords) return;
        
        // フィルタリング処理
        const fcFilter = document.getElementById('filter-fc').value;
        const missFilter = document.getElementById('filter-miss').value;
        const diffFilter = document.getElementById('filter-diff').value;
        const levelFilter = document.getElementById('filter-level').value;
        const bestOnly = document.getElementById('filter-best').checked;
        const titleFilter = document.getElementById('filter-title').value.trim().toLowerCase();

        let sourceRecords = [...allRecords]; // 元データを破壊しないようコピー

        // ベストスコアのみ抽出（曲名+難易度でユニーク化）
        if (bestOnly) {
          const bestMap = new Map();
          sourceRecords.forEach(rec => {
            const key = `${rec.title}_${rec.difficultyRaw}`;
            // よりミスが少ない、または同じミス数なら新しい日付(ここでは日付がないので登録順と仮定)を優先
            if (!bestMap.has(key) || rec.missCount < bestMap.get(key).missCount) {
              bestMap.set(key, rec);
            }
          });
          sourceRecords = Array.from(bestMap.values());
        }

        // フィルタ適用
        const filtered = sourceRecords.filter(record => {
          if (fcFilter === 'fc' && !record.isFC) return false;
          if (fcFilter === 'unfc' && record.isFC) return false;

          if (missFilter !== 'all') {
             if (record.isFC) return false; // ミスフィルタがある場合FCは除外
             const m = record.missCount;
             if (missFilter === 'range-1-5' && (m < 1 || m > 5)) return false;
             if (missFilter === 'range-6-10' && (m < 6 || m > 10)) return false;
             if (missFilter === 'range-11' && m < 11) return false;
          }

          if (diffFilter !== 'all' && record.difficultyRaw !== diffFilter) return false;
          if (levelFilter && record.level != levelFilter) return false;
          if (titleFilter && !record.title.toLowerCase().includes(titleFilter)) return false;
          
          return true;
        });

        // ソート処理
        const sortOrder = document.getElementById('sort-order').value;
        
        filtered.sort((a, b) => {
          const titleAsc = a.title.localeCompare(b.title, 'ja');
          const titleDesc = b.title.localeCompare(a.title, 'ja');
          const levelDesc = b.level - a.level;
          const levelAsc = a.level - b.level;
          const diffDesc = getDiffScore(b.difficultyRaw) - getDiffScore(a.difficultyRaw); 
          const missAsc = a.missCount - b.missCount;
          const missDesc = b.missCount - a.missCount;

          // 短絡評価 (||) を利用したマルチキーソート
          switch (sortOrder) {
            case 'title_asc': return titleAsc || diffDesc || missAsc;
            case 'title_desc': return titleDesc || diffDesc || missAsc;
            case 'level_desc': return levelDesc || titleAsc || diffDesc || missAsc;
            case 'level_asc': return levelAsc || titleAsc || diffDesc || missAsc;
            case 'miss_asc': return missAsc || levelDesc || diffDesc || titleAsc;
            case 'miss_desc': return missDesc || levelDesc || diffDesc || titleAsc;
            default: return 0;
          }
        });

        renderGrid(filtered);
      }

      function renderGrid(records) {
        const grid = document.getElementById('grid');
        const countLabel = document.getElementById('result-count');
        
        countLabel.textContent = `表示: ${records.length} 件`;
        
        if (records.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#666;">該当するデータがありません</div>';
          return;
        }

        // 高速化: mapでHTML文字列の配列を作成し、joinで結合して一度に描画
        const htmlParts = records.map(rec => {
          // サムネイルURL生成 (ドライブのサムネはサイズ指定可能)
          const thumbUrl = rec.thumbnail ? rec.thumbnail.replace('=s220', '=w600') : ''; 
          const largeUrl = rec.thumbnail ? rec.thumbnail.replace('=s220', '=w1600') : '';

          const fcClass = rec.isFC ? 'is-fc' : '';
          const missDisplay = rec.isFC ? 
            `<span class="miss-val zero">FC-0</span>` : 
            `FC -<span class="miss-val">${rec.missCount}</span>`;
          
          const badge = rec.isFC ? 
            `<div class="fc-badge"><span class="material-symbols-outlined" style="font-size:1rem;">crown</span> FULL COMBO</div>` : '';

          // エスケープ処理をして安全性を高める
          const safeTitle = escapeHtml(rec.title);
          const safeId = escapeHtml(rec.id);

          return `
            <div class="card ${fcClass}">
              <div class="card-img-container" onclick="openImageModal('${largeUrl}')">
                <button class="delete-btn" onclick="confirmDelete('${safeId}', '${safeTitle}')" title="削除">
                  <span class="material-symbols-outlined">delete</span>
                </button>
                ${badge}
                <div class="img-loader-spinner"></div>
                ${thumbUrl ? 
                  `<img src="${thumbUrl}" class="card-img" loading="lazy" 
                    onload="this.style.opacity=1; this.previousElementSibling.style.display='none';"
                    onerror="this.style.display='none'; this.parentElement.innerHTML+='<span style=\'color:#aaa\'>Img Error</span>'">` 
                  : '<span style="color:#aaa;">NO IMAGE</span>'}
              </div>
              <div class="card-body">
                <div class="song-meta">
                  <span class="tag lvl">Lv.${rec.level}</span>
                  <span class="tag diff-${rec.difficultyRaw}">${rec.difficulty}</span>
                </div>
                <div class="song-title" title="${safeTitle}">${safeTitle}</div>
                <div class="score-info">
                  <span style="display:flex; align-items:center; gap:2px;">
                    <span class="material-symbols-outlined" style="font-size:1rem;">bar_chart</span> Result
                  </span>
                  ${missDisplay}
                </div>
              </div>
            </div>
          `;
        });

        grid.innerHTML = htmlParts.join('');
      }
