<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>プロセカ リザルト管理</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
      :root {
        --bg-color: #f4f7f6;
        --card-bg: #ffffff;
        --text-color: #333;
        --diff-append: #FF82C4;
        --diff-master: #AC3EE6;
        --diff-expert: #DC5268;
        --diff-hard:    #E9B153;
        --fc-color:     #FF82FF;
      }
      body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
      .container { max-width: 800px; margin: 0 auto; }
      h1 { text-align: center; color: #444; margin-bottom: 30px; }
      
      .input-section {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 30px;
      }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
      input, select {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
        box-sizing: border-box; font-family: inherit; font-size: 1rem;
      }
      .row { display: flex; gap: 15px; }
      .col { flex: 1; }
      
      button.btn-add {
        width: 100%; padding: 12px; background-color: #333; color: #fff; border: none;
        border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
        margin-top: 10px;
      }
      button.btn-add:hover { opacity: 0.9; }

      .grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
      }
      .card {
        background: var(--card-bg); border-radius: 12px; overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s;
        display: flex; flex-direction: column;
      }
      .card:hover { transform: translateY(-3px); }
      
      .card-img {
        width: 100%; height: 160px; background-color: #eee;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        overflow: hidden;
      }
      .card-img img { width: 100%; height: 100%; object-fit: cover; }
      
      .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
      
      .song-meta { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
      .tag {
        padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: white;
      }
      .lvl { background-color: #888; }
      .diff-MASTER { background-color: var(--diff-master); }
      .diff-EXPERT { background-color: var(--diff-expert); }
      .diff-HARD { background-color: var(--diff-hard); }
      .diff-APPEND { background-color: var(--diff-append); }
      
      .song-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; line-height: 1.4; }
      
      .score-info {
        margin-top: auto; display: flex; justify-content: space-between; align-items: center;
        font-size: 0.9rem; color: #666; border-top: 1px solid #f0f0f0; padding-top: 10px;
      }
      .miss-badge {
        font-weight: bold; color: #FF4444; background: #FFF0F0;
        padding: 2px 8px; border-radius: 4px;
      }
      .fc-badge {
        font-weight: bold; color: #fff; background: var(--fc-color);
        padding: 2px 8px; border-radius: 4px;
      }

      /* Image Modal */
      .modal {
        display: none; position: fixed; z-index: 999; left: 0; top: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);
        align-items: center; justify-content: center;
      }
      .modal-content { max-width: 90%; max-height: 90%; border-radius: 8px; }
      
      #ocr-status { font-size: 0.85rem; color: #666; margin-top: 5px; min-height: 1.2em; }
    </style>
  </head>
  <body>

    <div class="container">
      <h1>プロセカ リザルト管理</h1>
      
      <div class="input-section">
        <div class="form-group">
          <label>スクリーンショット (自動解析)</label>
          <input type="file" id="inpFile" accept="image/*" onchange="handleFileSelect(this)">
          <div id="ocr-status"></div>
        </div>
        
        <div class="form-group">
          <label>楽曲タイトル</label>
          <input type="text" id="inpTitle" placeholder="楽曲名">
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>難易度</label>
              <select id="inpDiff">
                <option value="MASTER">MASTER</option>
                <option value="EXPERT">EXPERT</option>
                <option value="APPEND">APPEND</option>
                <option value="HARD">HARD</option>
              </select>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>レベル</label>
              <input type="number" id="inpLevel" placeholder="33">
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>Miss (Good+Bad+Miss)</label>
              <input type="number" id="inpMiss" placeholder="0">
            </div>
          </div>
        </div>

        <button class="btn-add" onclick="addRecord()">記録を追加</button>
      </div>

      <div class="grid" id="resultGrid">
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeImageModal()">
      <img class="modal-content" id="modalImg">
    </div>

    <script>
      let records = [];
      let currentImgData = null;
      let musicDatabase = [];

      // ページ読み込み時に楽曲データを取得
      window.addEventListener('load', async () => {
        try {
          const res = await fetch('https://raw.githubusercontent.com/Sekai-World/sekai-master-db-diff/master/musics.json');
          musicDatabase = await res.json();
          console.log("Music database loaded:", musicDatabase.length, "songs.");
        } catch (e) {
          console.error("Failed to load music database:", e);
          document.getElementById('ocr-status').innerText = "楽曲DBの読み込みに失敗しました。";
        }
      });

      async function handleFileSelect(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            currentImgData = e.target.result;
            recognizeImage(file);
          }
          reader.readAsDataURL(file);
        }
      }

      async function recognizeImage(file) {
        const statusEl = document.getElementById('ocr-status');
        statusEl.innerText = "画像を解析中... (Tesseract.js)";

        try {
          // 言語を日本語+英語に設定
          const { data: { text } } = await Tesseract.recognize(
            file,
            'jpn+eng',
            { logger: m => {
                if(m.status === 'recognizing text') {
                  statusEl.innerText = `解析中... ${Math.round(m.progress * 100)}%`;
                }
              }
            }
          );
          
          console.log("OCR Result Raw:", text);
          statusEl.innerText = "解析完了。データを適用しました。";
          
          processOCRResult(text);

        } catch (error) {
          console.error(error);
          statusEl.innerText = "解析に失敗しました。";
        }
      }

      function processOCRResult(text) {
        // 1. 難易度推定 (APPEND, MASTER, EXPERT, HARD)
        const diffs = ['APPEND', 'MASTER', 'EXPERT', 'HARD'];
        // テキスト全体から最も一致する難易度を探す
        // 大文字小文字を区別せず、含まれているかチェック
        const upperText = text.toUpperCase();
        let foundDiff = 'MASTER'; // デフォルト
        let maxScore = -1;

        // OCRの誤認識も考慮して少し柔軟に探す（単純なincludes検索）
        for (const diff of diffs) {
          if (upperText.includes(diff)) {
            foundDiff = diff;
            break; 
          }
        }
        document.getElementById('inpDiff').value = foundDiff;

        // 2. レベル推定 (Lv.34 などを探す)
        // パターン: "Lv" や "Lv." の後に続く数字
        const levelMatch = text.match(/Lv\.?\s*(\d+)/i);
        if (levelMatch) {
          document.getElementById('inpLevel').value = levelMatch[1];
        }

        // 3. ミス数 (Good + Bad + Miss) の計算
        // OCRテキスト内から GOOD, BAD, MISS の数値を抽出する
        // 形式例: "GOOD 10", "GOOD\n10", "Bad 4" など
        // 誤認識対策: 0 (ゼロ) が O (オー) になったり、数字が離れている場合を考慮
        
        const getCount = (label) => {
          // 正規表現: ラベル(GOOD等)の後に、数字ではない文字が0文字以上続き、その後に数字がある
          // 例: "GOOD 10", "GOOD : 10", "GOOD\n10"
          const regex = new RegExp(`${label}[^0-9]*([0-9]+)`, 'i');
          const match = text.match(regex);
          return match ? parseInt(match[1], 10) : 0;
        };

        const goodCount = getCount('GOOD');
        const badCount = getCount('BAD');
        const missCount = getCount('MISS');

        // デバッグ用ログ
        console.log(`Judgments -> Good:${goodCount}, Bad:${badCount}, Miss:${missCount}`);
        
        const totalMiss = goodCount + badCount + missCount;
        
        // もし解析結果が全て0の場合で、かつテキスト量がある場合は
        // 誤検知の可能性が高いので強制上書きしない、あるいは0を入れる
        // ここでは単純に計算結果を入れる
        document.getElementById('inpMiss').value = totalMiss;

        // 4. 楽曲タイトルのマッチング
        // OCRテキストを行ごとに分割し、DB内のタイトルと類似度比較を行う
        if (musicDatabase.length > 0) {
          const lines = text.split(/\r?\n/).filter(line => line.trim().length > 2); // 短すぎるゴミ行は除外
          let bestMatchTitle = "";
          let minDistance = Infinity;

          // 全行 x 全楽曲 で比較 (少し重いがブラウザJSなら許容範囲)
          lines.forEach(line => {
             // 読み取った行のノイズ除去 (記号などを消す)
             const cleanLine = line.trim();
             
             musicDatabase.forEach(music => {
               // 完全一致があれば即終了
               if (music.title === cleanLine) {
                 bestMatchTitle = music.title;
                 minDistance = 0;
               }
               
               // レーベンシュタイン距離を計算
               // ただし、計算量を減らすため、長さが大きく違う場合はスキップ
               if (Math.abs(music.title.length - cleanLine.length) > 5) return;

               const dist = levenshtein(cleanLine, music.title);
               if (dist < minDistance) {
                 minDistance = dist;
                 bestMatchTitle = music.title;
               }
             });
          });

          // しきい値: あまりにも似ていない場合は適用しない (誤爆防止)
          // タイトル長に対して距離が大きすぎる場合は無視
          if (bestMatchTitle && minDistance < bestMatchTitle.length * 0.4) {
             document.getElementById('inpTitle').value = bestMatchTitle;
          } else {
             // マッチしなかった場合は、一番「それっぽい」行を入れるか、空にする
             // ここでは空にしてユーザーに入力させる
             console.log("No good title match found. Best was: " + bestMatchTitle + " (Dist: " + minDistance + ")");
          }
        }
      }

      // レーベンシュタイン距離 (文字列の類似度計算)
      function levenshtein(s1, s2) {
        const len1 = s1.length;
        const len2 = s2.length;
        const d = [];

        for (let i = 0; i <= len1; i++) d[i] = [i];
        for (let j = 0; j <= len2; j++) d[0][j] = j;

        for (let i = 1; i <= len1; i++) {
          for (let j = 1; j <= len2; j++) {
            const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
            d[i][j] = Math.min(
              d[i - 1][j] + 1,        // deletion
              d[i][j - 1] + 1,        // insertion
              d[i - 1][j - 1] + cost  // substitution
            );
          }
        }
        return d[len1][len2];
      }

      function addRecord() {
        const title = document.getElementById('inpTitle').value;
        const difficulty = document.getElementById('inpDiff').value;
        const level = document.getElementById('inpLevel').value;
        const miss = document.getElementById('inpMiss').value;
        
        if(!title) { alert("楽曲タイトルを入力してください"); return; }

        const rec = {
          id: Date.now(),
          title,
          difficulty,
          difficultyRaw: difficulty, // CSSクラス用
          level,
          miss,
          img: currentImgData
        };
        
        records.unshift(rec);
        renderGrid();
        
        // Reset inputs (keep image for reference if needed, but usually clear)
        document.getElementById('inpTitle').value = '';
        document.getElementById('inpMiss').value = '0';
      }

      function renderGrid() {
        const grid = document.getElementById('resultGrid');
        grid.innerHTML = '';
        
        records.forEach(rec => {
          const isFC = rec.miss == 0;
          const missDisplay = isFC 
            ? `<span class="fc-badge">FULL COMBO</span>` 
            : `<span class="miss-badge">${rec.miss} Miss</span>`; // ここでのMissはGood+Bad+Missの合計

          const imgHtml = rec.img 
            ? `<img src="${rec.img}" alt="Result Image">`
            : '<span style="color:#aaa;">NO IMAGE</span>';

          const html = `
            <div class="card">
              <div class="card-img" onclick="openImageModal('${rec.img}')">
                ${imgHtml}
              </div>
              <div class="card-body">
                <div class="song-meta">
                  <span class="tag lvl">Lv.${rec.level}</span>
                  <span class="tag diff-${rec.difficultyRaw}">${rec.difficulty}</span>
                </div>
                <div class="song-title">${escapeHtml(rec.title)}</div>
                <div class="score-info">
                  <span style="display:flex; align-items:center; gap:2px;">
                    <span class="material-symbols-outlined" style="font-size:1rem;">bar_chart</span> Result
                  </span>
                  ${missDisplay}
                </div>
              </div>
            </div>
          `;
          grid.innerHTML += html;
        });
      }

      function openImageModal(src) {
        if(!src || src === 'null') return;
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        modal.style.display = "flex";
        modalImg.src = src;
      }

      function closeImageModal() {
        document.getElementById('imageModal').style.display = "none";
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text.toString().replace(/[&<>"']/g, function(m) {
          return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
        });
      }
    </script>
  </body>
</html>
